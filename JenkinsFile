pipeline {
    agent { docker {
    image 'golang'
    args '-u root:sudo -v $HOME'
    } }
    stages {
        stage('build') {
            steps {
                sh 'go version'
                sh 'go clean -cache'
                sh 'go build ./cmd/activity_manager_bootstrap.go'
                sh 'go test ./...'
                sh 'curl -fsSLO https://get.docker/builds/Linux/x86_64/docker-17.04.0-ce.tgz'
                sh 'tar xzvf docker-17.04.0-ce.tgz'
                sh 'mv docker/docker /usr/local/bin'
                sh 'rm -r docker docker-17.04.0-ce.tgz'

            }

        }

        stage('Build docker image') {
                   steps {
                       script {
                               def customImage = docker.build('singaravelan21/todo_list_manager', "./")
                               docker.withRegistry('https://registry.hub.docker.com', 'dockerhub') {
                               customImage.push("${env.BUILD_NUMBER}")
                                }
                               }
                }
        	  }
            }
    }